<!DOCTYPE html><html><head><meta charset="utf-8"><title>PHP定时器那点事 | 技术学派</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="IT培训, Python, 大数据, 人工智能, Web前端, PHP, php"><meta name="description" content="常见的定时器有两种：一种周期性定时执行，例如每天的凌晨三点出报表；另一种在指定时间后执行（一次），例如会员登录系统五分钟后发放每日登录奖励。两种情况对应shell中的cron和at命令，与JavaScript中的setInterval和setTimeout函数类似（严格来说setInterval是周期性执行，指定时间点执行需要自行处理）。做web开发的PHP程序员对JavaScript中的两个定时"><meta name="keywords" content="php"><meta property="og:type" content="article"><meta property="og:title" content="PHP定时器那点事"><meta property="og:url" content="http://www.JiShuXuePai.com/blog/学习答疑/学习答疑/PHP定时器那点事/index.html"><meta property="og:site_name" content="技术学派"><meta property="og:description" content="常见的定时器有两种：一种周期性定时执行，例如每天的凌晨三点出报表；另一种在指定时间后执行（一次），例如会员登录系统五分钟后发放每日登录奖励。两种情况对应shell中的cron和at命令，与JavaScript中的setInterval和setTimeout函数类似（严格来说setInterval是周期性执行，指定时间点执行需要自行处理）。做web开发的PHP程序员对JavaScript中的两个定时"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="http://www.jishuxuepai.com/blog/学习答疑/学习答疑/PHP定时器那点事/01.jpg"><meta property="og:updated_time" content="2018-06-23T08:56:06.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="PHP定时器那点事"><meta name="twitter:description" content="常见的定时器有两种：一种周期性定时执行，例如每天的凌晨三点出报表；另一种在指定时间后执行（一次），例如会员登录系统五分钟后发放每日登录奖励。两种情况对应shell中的cron和at命令，与JavaScript中的setInterval和setTimeout函数类似（严格来说setInterval是周期性执行，指定时间点执行需要自行处理）。做web开发的PHP程序员对JavaScript中的两个定时"><meta name="twitter:image" content="http://www.jishuxuepai.com/blog/学习答疑/学习答疑/PHP定时器那点事/01.jpg"><link rel="stylesheet" href="/libs/bootstrap/bootstrap-grid.css"><link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/libs/titillium-web/styles.css"><link rel="stylesheet" href="/libs/source-code-pro/styles.css"><link rel="stylesheet" href="/css/style.css"><script src="/libs/jquery/jquery.min.js"></script><link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css"><link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?4c1bd812de3c30edbaa2b803c66f0a04";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head></html><body><div id="wrap"><header id="header"><div id="header-outer" class="outer"><div class="container"><div class="container-inner"><div id="header-title"><h1 class="logo-wrap"><a href="/" class="logo"></a></h1></div><div id="header-inner" class="nav-container"><a id="main-nav-toggle" class="nav-icon fa fa-bars">菜单</a><div class="nav-container-inner"><ul id="main-nav"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/">主页</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/edu/index.html">学编程</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/blog/">博客</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/tips.html">学习建议</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/about.html">关于</a></li></ul><nav id="sub-nav"><div id="search-form-wrap"><form class="search-form"><input type="text" class="ins-search-input search-form-input" placeholder="搜索"> <button type="submit" class="search-form-submit"></button></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..."> <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script></div></nav></div></div></div></div></div></header><div class="container"><div class="main-body container-inner"><div class="main-body-inner"><section id="main"><div class="main-body-header"><h1 class="header"><a class="page-title-link" href="/categories/学习答疑/">学习答疑</a><div class="author"></div></h1></div><div class="main-body-content"><article id="post-学习答疑/PHP定时器那点事" class="article article-single article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">PHP定时器那点事</h1></header><div class="article-meta"><div class="article-date"><a href="/blog/学习答疑/学习答疑/PHP定时器那点事/" class="article-date"><time datetime="2018-06-22T08:07:34.000Z" itemprop="datePublished">2018-06-22</time></a></div><div class="article-tag"><i class="fa fa-tag"></i> <a class="tag-link" href="/tags/php/">php</a></div></div><div class="article-entry" itemprop="articleBody"><p>常见的定时器有两种：一种周期性定时执行，例如每天的凌晨三点出报表；另一种在指定时间后执行（一次），例如会员登录系统五分钟后发放每日登录奖励。两种情况对应shell中的<code>cron</code>和<code>at</code>命令，与<code>JavaScript</code>中的<code>setInterval</code>和<code>setTimeout</code>函数类似（严格来说<code>setInterval</code>是周期性执行，指定时间点执行需要自行处理）。</p><img src="/blog/学习答疑/学习答疑/PHP定时器那点事/01.jpg" title="Markdown 语法"><p>做web开发的PHP程序员对JavaScript中的两个定时器函数应该都还熟悉，回到PHP层面就有点傻眼：PHP中有<code>sleep</code>，但是没有（内置）定时器函数可用。<code>sleep</code>函数勉强可以做到，但会导致进程阻塞，期间不能做其他事（或无响应）。为什么PHP没能提供定时器（Timer）这个功能呢？</p><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>web开发中PHP不能使用定时器的本质原因是<strong>可控</strong> <strong>常驻内存运行环境</strong>的缺失。两个要点：第一常驻内存，第二可控。CGI模式下，进程执行完脚本后直接退出，不能指望其到指定时间运行任务；PHP-FPM模式下，进程（绝大多数）常驻内存，但不可控。</p><p>不可控的意思是执行PHP的进程不受PHP代码影响，进程的入口点和退出时机由额外的程序控制。例如FPM模式下，PHP脚本中的<code>exit</code>、<code>die</code>函数只中断脚本的执行，不会对执行脚本的进程产生特别的影响（内存泄露除外）。PHP开发人员编写的脚本是进程的执行体，执行完毕后就从进程的执行上下文中卸载出去。这种情况下，执行PHP脚本的时机仍然由外部驱动，没有外部请求PHP代码就安详的躺在硬盘上，什么都不做，也就定时任务。</p><p>由于PHP主要面向web开发，PHP这种执行模式稳定可靠，开发效率快。比如省去资源释放这一步，就避免了开发中很多工作量和坑。想想某些第三方库代码中改时区、字符编码等还不还原，在常驻内存运行环境下几乎肯定会导致后续请求有问题。但在FPM模式下，这种坑无意中直接趟平，省去许多调试时间，为程序员保住发际线做出了不小的贡献。</p><p>问题已经了解，那么PHP中如何使用定时器执行定时任务？</p><h3 id="危险的做法"><a href="#危险的做法" class="headerlink" title="危险的做法"></a>危险的做法</h3><p>在web环境下，PHP脚本默认有超时时间。去掉超时设置，就可以让程序一直在后台运行（如果进程不退出的话）。例如以下代码在响应请求后继续后台运行，并且每五秒钟输出一次时间到文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># test.php</span><br><span class="line">set_time_limit(0); # 取消超时设置，让脚本可一直运行</span><br><span class="line"></span><br><span class="line">echo &apos;This is a background run forever script. Now you can leave me alone.&apos;;</span><br><span class="line"></span><br><span class="line">fastcgi_finish_request();   # 结束当前请求</span><br><span class="line"></span><br><span class="line">do&#123;</span><br><span class="line">   file_put_contents(&quot;/tmp/out.dat&quot;, &quot;test script, now:&quot; . date(&quot;Y-m-d H:i:s&quot;) . &quot;\n&quot;, FILE_APPEND);</span><br><span class="line">   sleep(5);</span><br><span class="line">&#125;while(true);</span><br></pre></td></tr></table></figure><p>请求<code>http://localhost:8080/test.php</code>文件后，监测<code>/tmp/out.dat</code>文件，会发现不断有内容输出，无论客户端是否断开连接、关闭浏览器或者重启电脑（不能重启服务器）。这说明程序一直在执行，并且也实现了我们想要的定时器功能。如果把<code>sleep</code>改成<code>usleep</code>、<code>time_nanosleep</code>，还能实现微秒、纳秒级定时器，岂不美哉？</p><p>实践中应当尽量避免用这种方式实现定时器，不仅因为低效，还略有危险。原因之一是每次请求会占用一个进程，请求十万次需要十万个进程，基本上会导致系统崩溃或后续请求无响应；另外如果打开了session，但是忘记调用<code>session_write_close</code>，会导致同一个用户的后续请求被hang住（session活跃时处于加锁状态，不关闭session会导致后续进程无法打开session）。</p><p>web开发应当越快响应用户的请求越好，在web开发中用这种方式强行实现定时器，会让整个web应用处于不稳定、不可靠或不可预测状态。孟子曰：知而慎行，君子不立于危墙之下。不靠谱的做法要尽量避免，顺带也避免背锅和甩锅。</p><p>接下来看看PHP中使用定时器的正确姿势。</p><h3 id="正确的姿势"><a href="#正确的姿势" class="headerlink" title="正确的姿势"></a>正确的姿势</h3><p>PHP实现定时器的做法可简单归结为如下几种：</p><ol><li>使用cron、Jenkins等调度工具做周期性定时任务（既可以是执行脚本，也可以是请求某个网址）；</li><li>一次性执行任务通过消息队列、数据库等方式投递给第三方程序执行；</li><li>像WordPress一样模拟定时任务，但要记住这种方式依赖于客户端请求，并需自行处理好进程并发问题；</li><li>使用常驻内存型方式运行PHP程序，即CLI模式。</li></ol><p>除了第三种做法，其他方式都是推荐的，具体方案请结合实际需求。作为PHP程序员，当然还是首选用PHP来做，也就是CLI模式。</p><h3 id="CLI模式"><a href="#CLI模式" class="headerlink" title="CLI模式"></a>CLI模式</h3><p>摸着良心说，CLI模式让PHP发挥的空间拓展不少。在CLI模式下，程序的入口点就是脚本，且代码可以常驻内存，进程完全由PHP代码控制。在这种形式下，实现定时器就有多种玩法。本文列出几种做法，抛砖引玉：</p><ol><li>使用<code>swoole</code>、<code>workerman</code>等框架，内置（高精度）定时器；</li><li>使用多进程（池）/多线程（池）技术（<code>pcntl</code>、<code>pthreads</code>拓展在CLI模式下才可用）；</li><li>处理tick或者alarm等信号；</li><li>使用<code>libevent</code>、<code>libev</code>等事件驱动库；</li><li><code>sleep</code>加循环或自己实现事件循环。</li></ol><p>想折腾的话自己用2-5方案，不想折腾<code>swoole</code>、<code>workerman</code>等框架是首选，稳定可靠。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>区分HTTP请求和任务的关系，实现定时任务就简单了。至于用不用PHP来实现，那是另外一回事。当然作为web开发的首选语言，PHP实现定时任务也是轻而易举的。</p></div><footer class="article-footer"><a data-url="http://www.JiShuXuePai.com/blog/学习答疑/学习答疑/PHP定时器那点事/" data-id="cjjgevlko003hz8fyfd36h5c9" class="article-share-link"><i class="fa fa-share"></i>分享到</a><script>!function(n){n("body").on("click",function(){n(".article-share-box.on").removeClass("on")}).on("click",".article-share-link",function(t){t.stopPropagation();var e,a=n(this),o=a.attr("data-url"),r=encodeURIComponent(o),i="article-share-box-"+a.attr("data-id"),s=a.offset();if(n("#"+i).length){if((e=n("#"+i)).hasClass("on"))return void e.removeClass("on")}else{var l=['<div id="'+i+'" class="article-share-box">','<input class="article-share-input" value="'+o+'">','<div class="article-share-links">','<a href="https://twitter.com/intent/tweet?url='+r+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="https://www.facebook.com/sharer.php?u='+r+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="http://pinterest.com/pin/create/button/?url='+r+'" class="article-share-pinterest" target="_blank" title="Pinterest"></a>','<a href="https://plus.google.com/share?url='+r+'" class="article-share-google" target="_blank" title="Google+"></a>',"</div>","</div>"].join("");e=n(l),n("body").append(e)}n(".article-share-box.on").hide(),e.css({top:s.top+25,left:s.left}).addClass("on")}).on("click",".article-share-box",function(t){t.stopPropagation()}).on("click",".article-share-box-input",function(){n(this).select()}).on("click",".article-share-box-link",function(t){t.preventDefault(),t.stopPropagation(),window.open(this.href,"article-share-box-window-"+Date.now(),"width=500,height=450")})}(jQuery)</script></footer></div></article><section id="comments"><div id="gitalk_frame"></div></section></div></section><aside id="sidebar"><a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a><div class="sidebar-top"><p>关注我 :</p><ul class="social-links"><li><a class="social-tooltip" title="火星时代" href="http://edu.hxsd.com/edunew/topics/webfull/index.html" target="_blank"><i class="icon fa fa-dribbble"></i></a></li><li><a class="social-tooltip" title="weibo" href="#" target="_blank"><i class="icon fa fa-weibo"></i></a></li><li><a class="social-tooltip" title="rss" href="/atom.xml" target="_blank"><i class="icon fa fa-rss"></i></a></li></ul></div><nav id="article-nav"><a href="/blog/学习答疑/学习答疑/人工智能领域的职业所需技能是什么？你知道吗？/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">下一篇</strong><p class="article-nav-title">人工智能领域的职业所需技能是什么？你知道吗？</p><i class="icon fa fa-chevron-right" id="icon-chevron-right"></i> </a><a href="/blog/学习答疑/学习答疑/用Python写一个简单的推荐系统/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">上一篇</strong><p class="article-nav-title">用python写一个简单的推荐系统</p><i class="icon fa fa-chevron-left" id="icon-chevron-left"></i></a></nav><div class="widgets-container"><div class="widget-wrap widget-list"><h3 class="widget-title">分类</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/animate/">animate</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/html/">html</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习答疑/">学习答疑</a><span class="category-list-count">43</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/插件资源库/">插件资源库</a><span class="category-list-count">4</span></li></ul></div></div><link rel="stylesheet" href="/css/tech/toc.css"><div class="widget-wrap widget-list widget-toc"><h3 class="widget-title">目录</h3><div class="widget"><div class="toc"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/3.0.5/tocbot.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/3.0.5/tocbot.min.js"></script><script>$(function(){$(".main-body-content").find("h1,h2,h3").each(function(t){$(this).attr("id")||$(this).attr("id","list"+t)}),tocbot.init({tocSelector:".toc",contentSelector:".main-body-content",headingSelector:"h1, h2, h3",collapseDepth:2,positionFixedSelector:".widget-toc",fixedSidebarOffset:595,includeHtml:!1})})</script></div></div><div class="widget-wrap widget-list"><h3 class="widget-title">标签</h3><div class="widget"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/">php</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web前端/">web前端</a><span class="tag-list-count">2</span></li></ul></div></div><div class="widget-wrap widget-float"><h3 class="widget-title">标签云</h3><div class="widget tagcloud"><a href="/tags/C/" style="font-size:15px">C</a> <a href="/tags/go/" style="font-size:10px">go</a> <a href="/tags/php/" style="font-size:10px">php</a> <a href="/tags/python/" style="font-size:20px">python</a> <a href="/tags/web前端/" style="font-size:15px">web前端</a></div></div><div class="widget-wrap widget-list"><h3 class="widget-title">链接</h3><div class="widget"><ul><li><a href="http://edu.hxsd.com/edunew/topics/webfull/index.html">火星时代</a></li></ul></div></div></div></aside><script>$(function(){$(window).scroll(function(){240<=$(document).scrollTop()?($("#sidebar .sidebar-toggle").addClass("fix"),"block"==$("#sidebar .sidebar-toggle").css("display")&&$(".is-position-fixed").css("top","35px")):$("#sidebar .sidebar-toggle").removeClass("fix")})})</script></div></div></div><footer id="footer"><div class="top"><div class="inner"><div class="list"><div class="left clearfix"><dl><dt>关于我们</dt><dd><a href="/about.html" target="_blank">公司简介</a></dd><dd><a href="edu/index.html" target="_blank">联系我们</a></dd></dl><dl><dt>校区攻略</dt><dd><a href="edu/index.html" target="_blank">校区环境</a></dd><dd><a href="edu/index.html" target="_blank">住宿攻略</a></dd><dd><a href="edu/index.html" target="_blank">来校路线</a></dd></dl><dl><dt>课程培训</dt><dd><a href="edu/python.html" target="_blank">Python</a></dd><dd><a href="edu/python.html" target="_blank">Web前端</a></dd><dd><a href="edu/python.html" target="_blank">PHP</a></dd><dd><a href="edu/python.html" target="_blank">人工智能</a></dd><dd><a href="edu/python.html" target="_blank">大数据</a></dd></dl><dl><dt>常见问答</dt><dd><a href="edu/index.html" target="_blank">学费学时</a></dd><dd><a href="edu/index.html" target="_blank">学习方法</a></dd></dl></div></div><div class="tel"><img src="css/images/phone.png"><tel>176-0025-8815</tel><span>北京市海淀区杏石口路81号火星时代大厦</span></div><div class="weixin"><div class="w1"><img src="css/images/toutiao.jpeg"> <span>头条号</span></div><div class="w1"><img src="css/images/weixin.jpg"> <span>官方微信</span></div></div></div></div><div class="bot">Copyright 2018 技术学派 京ICP备15015508号-3</div></footer><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk=new Gitalk({clientID:"2fbbb9980b49019d99a7",clientSecret:"152dd10e83ef6595761ea2185304f9ac8263573f",repo:"jsxp",owner:"li-kang",admin:["li-kang"]});gitalk.render("gitalk_frame")</script><script src="/libs/lightgallery/js/lightgallery.min.js"></script><script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script><script src="/libs/lightgallery/js/lg-pager.min.js"></script><script src="/libs/lightgallery/js/lg-autoplay.min.js"></script><script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script><script src="/libs/lightgallery/js/lg-zoom.min.js"></script><script src="/libs/lightgallery/js/lg-hash.min.js"></script><script src="/libs/lightgallery/js/lg-share.min.js"></script><script src="/libs/lightgallery/js/lg-video.min.js"></script><script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="/js/main.js"></script></div></body>